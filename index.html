<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Conflict of Nations WebApp</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  body {
    background: #1e1e2f;
    color: white;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    padding: 20px;
    max-width: 500px;
    margin: auto;
  }
  h1, h2 {
    text-align: center;
    margin-bottom: 15px;
  }
  button {
    background-color: #007bff;
    border: none;
    color: white;
    padding: 12px 25px;
    margin: 8px 0;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    width: 100%;
  }
  input {
    width: 100%;
    padding: 10px;
    margin-top: 8px;
    margin-bottom: 15px;
    border-radius: 6px;
    border: none;
    font-size: 16px;
  }
  .hidden { display: none; }
  .section {
    margin-top: 20px;
    padding: 15px;
    background: #2e2e45;
    border-radius: 10px;
  }
  label {
    font-weight: bold;
  }
  .result {
    margin-top: 10px;
    padding: 10px;
    background: #444466;
    border-radius: 6px;
    min-height: 40px;
  }
</style>
</head>
<body>
<h1>ü™ñ Conflict of Nations WebApp</h1>

<div id="menu" class="section">
  <button onclick="showSection('analyze')">‚öîÔ∏è –ê–Ω–∞–ª—ñ–∑ –±–æ—é</button>
  <button onclick="showSection('calculator')">üìâ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤—Ç—Ä–∞—Ç</button>
  <button onclick="showSection('forecast')">üîÆ –ü—Ä–æ–≥–Ω–æ–∑ –±–æ—é</button>
  <button onclick="showSection('converter')">üí∞ –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä —Ä–µ—Å—É—Ä—Å—ñ–≤</button>
  <button onclick="showSection('tracker')">üìä –¢—Ä–µ–∫–µ—Ä –ø—Ä–æ–≥—Ä–µ—Å—É</button>
</div>

<div id="analyze" class="section hidden">
  <h2>‚öîÔ∏è –ê–Ω–∞–ª—ñ–∑ –±–æ—é</h2>
  <label>–ê—Ç–∞–∫—É—é—á—ñ —Å–∏–ª–∏:</label>
  <input type="number" id="analyze_attack" placeholder="–í–≤–µ–¥–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å" />
  <label>–û–±–æ—Ä–æ–Ω–Ω—ñ —Å–∏–ª–∏:</label>
  <input type="number" id="analyze_defense" placeholder="–í–≤–µ–¥–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å" />
  <button onclick="analyzeBattle()">–ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏</button>
  <div id="analyze_result" class="result"></div>
</div>

<div id="calculator" class="section hidden">
  <h2>üìâ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤—Ç—Ä–∞—Ç</h2>
  <label>–ê—Ç–∞–∫—É—é—á—ñ —Å–∏–ª–∏:</label>
  <input type="number" id="calc_attack" placeholder="–í–≤–µ–¥–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å" />
  <label>–û–±–æ—Ä–æ–Ω–Ω—ñ —Å–∏–ª–∏:</label>
  <input type="number" id="calc_defense" placeholder="–í–≤–µ–¥–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å" />
  <button onclick="calculateLosses()">–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –≤—Ç—Ä–∞—Ç–∏</button>
  <div id="calculator_result" class="result"></div>
</div>

<div id="forecast" class="section hidden">
  <h2>üîÆ –ü—Ä–æ–≥–Ω–æ–∑ –±–æ—é</h2>
  <label>–ê—Ç–∞–∫—É—é—á—ñ —Å–∏–ª–∏:</label>
  <input type="number" id="forecast_attack" placeholder="–í–≤–µ–¥–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å" />
  <label>–û–±–æ—Ä–æ–Ω–Ω—ñ —Å–∏–ª–∏:</label>
  <input type="number" id="forecast_defense" placeholder="–í–≤–µ–¥–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å" />
  <button onclick="forecastBattle()">–û—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑</button>
  <div id="forecast_result" class="result"></div>
</div>

<div id="converter" class="section hidden">
  <h2>üí∞ –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä —Ä–µ—Å—É—Ä—Å—ñ–≤</h2>
  <label>–ú–µ—Ç–∞–ª:</label>
  <input type="number" id="convert_metal" placeholder="–í–≤–µ–¥–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å" />
  <label>–ü–∞–ª–∏–≤–æ:</label>
  <input type="number" id="convert_fuel" placeholder="–í–≤–µ–¥–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å" />
  <button onclick="convertResources()">–ö–æ–Ω–≤–µ—Ä—Ç—É–≤–∞—Ç–∏</button>
  <div id="converter_result" class="result"></div>
</div>

<div id="tracker" class="section hidden">
  <h2>üìä –¢—Ä–µ–∫–µ—Ä –ø—Ä–æ–≥—Ä–µ—Å—É</h2>
  <button onclick="showHistory()">–ü–æ–∫–∞–∑–∞—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é</button>
  <div id="tracker_result" class="result"></div>
</div>

<script>
  const tg = window.Telegram.WebApp;
  tg.expand();

  function showSection(sectionId) {
    const sections = ['analyze','calculator','forecast','converter','tracker'];
    sections.forEach(id => {
      document.getElementById(id).classList.add('hidden');
    });
    document.getElementById(sectionId).classList.remove('hidden');
  }

  function sendData(type, payload) {
    const data = JSON.stringify({type, ...payload});
    tg.sendData(data);
  }

  // –ê–Ω–∞–ª—ñ–∑ –±–æ—é
  function analyzeBattle() {
    const atk = Number(document.getElementById('analyze_attack').value);
    const def = Number(document.getElementById('analyze_defense').value);
    if (!atk || !def) {
      alert("–í–≤–µ–¥–∏ –∫–æ—Ä–µ–∫—Ç–Ω—ñ —á–∏—Å–ª–∞");
      return;
    }
    const eff = (atk / (def + 1) * 100).toFixed(2);
    document.getElementById('analyze_result').innerText = `–ï—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –±–æ—é: ${eff}%`;
    sendData('analyze', {attack: atk, defense: def, efficiency: eff});
  }

  // –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤—Ç—Ä–∞—Ç (–ø—Ä–æ—Å—Ç–∞ –º–æ–¥–µ–ª—å)
  function calculateLosses() {
    const atk = Number(document.getElementById('calc_attack').value);
    const def = Number(document.getElementById('calc_defense').value);
    if (!atk || !def) {
      alert("–í–≤–µ–¥–∏ –∫–æ—Ä–µ–∫—Ç–Ω—ñ —á–∏—Å–ª–∞");
      return;
    }
    // –ü—Ä–∏–∫–ª–∞–¥ –ø—Ä–æ—Å—Ç–∞ —Ñ–æ—Ä–º—É–ª–∞ –≤—Ç—Ä–∞—Ç: –≤—Ç—Ä–∞—Ç–∞ = 30% —É –≤–ª–∞—Å–Ω–∏—Ö —Å–∏–ª–∞—Ö, 50% —É –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞
    const atkLoss = Math.round(atk * 0.3);
    const defLoss = Math.round(def * 0.5);
    document.getElementById('calculator_result').innerText = `–í—Ç—Ä–∞—Ç–∏ –∞—Ç–∞–∫—É—é—á–∏—Ö: ${atkLoss}\n–í—Ç—Ä–∞—Ç–∏ –æ–±–æ—Ä–æ–Ω–Ω–∏—Ö: ${defLoss}`;
    sendData('calculator', {attack: atk, defense: def, atkLoss, defLoss});
  }

  // –ü—Ä–æ–≥–Ω–æ–∑ –±–æ—é (–æ—á–µ–Ω—å —Å–ø—Ä–æ—â–µ–Ω–∏–π)
  function forecastBattle() {
    const atk = Number(document.getElementById('forecast_attack').value);
    const def = Number(document.getElementById('forecast_defense').value);
    if (!atk || !def) {
      alert("–í–≤–µ–¥–∏ –∫–æ—Ä–µ–∫—Ç–Ω—ñ —á–∏—Å–ª–∞");
      return;
    }
    let winner = '–ù—ñ—á–∏—è';
    if(atk > def * 1.2) winner = '–ü–µ—Ä–µ–º–æ–≥–∞ –∞—Ç–∞–∫—É—é—á–∏—Ö';
    else if(def > atk * 1.2) winner = '–ü–µ—Ä–µ–º–æ–≥–∞ –æ–±–æ—Ä–æ–Ω–Ω–∏—Ö';

    document.getElementById('forecast_result').innerText = `–ü—Ä–æ–≥–Ω–æ–∑: ${winner}`;
    sendData('forecast', {attack: atk, defense: def, forecast: winner});
  }

  // –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä —Ä–µ—Å—É—Ä—Å—ñ–≤ (–ø—Ä–∏–∫–ª–∞–¥ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó: 1 –º–µ—Ç–∞–ª = 2 –ø–∞–ª–∏–≤–æ)
  function convertResources() {
    const metal = Number(document.getElementById('convert_metal').value);
    if (!metal) {
      alert("–í–≤–µ–¥–∏ –∫–æ—Ä–µ–∫—Ç–Ω–µ —á–∏—Å–ª–æ –º–µ—Ç–∞–ª—É");
      return;
    }
    const fuel = metal * 2;
    document.getElementById('converter_result').innerText = `${metal} –º–µ—Ç–∞–ª—ñ–≤ = ${fuel} –ø–∞–ª–∏–≤–∞`;
    sendData('converter', {metal, fuel});
  }

  // –¢—Ä–µ–∫–µ—Ä –ø—Ä–æ–≥—Ä–µ—Å—É (–∑–±–µ—Ä—ñ–≥–∞—î–º–æ —É localStorage)
  function showHistory() {
    const history = JSON.parse(localStorage.getItem('battle_history') || '[]');
    if (history.length === 0) {
      document.getElementById('tracker_result').innerText = "–Ü—Å—Ç–æ—Ä—ñ—è –ø–æ–∫–∏ –ø–æ—Ä–æ–∂–Ω—è.";
      return;
    }
    let text = "–û—Å—Ç–∞–Ω–Ω—ñ –¥—ñ—ó:\n";
    history.slice(-5).forEach((item, i) => {
      text += `${i+1}. [${item.type}] ${JSON.stringify(item.data)}\n`;
    });
    document.getElementById('tracker_result').innerText = text;
  }

  // –ü–µ—Ä–µ—Ö–æ–ø–ª–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–∏—Ö, —â–æ–± –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ —ó—Ö –≤ —ñ—Å—Ç–æ—Ä—ñ—ó
  const originalSendData = tg.sendData.bind(tg);
  tg.sendData = function(data) {
    try {
      const parsed = JSON.parse(data);
      let history = JSON.parse(localStorage.getItem('battle_history') || '[]');
      history.push({type: parsed.type || 'unknown', data: parsed, timestamp: new Date().toISOString()});
      if (history.length > 50) history.shift(); // –º–∞–∫—Å–∏–º—É–º 50 –∑–∞–ø–∏—Å—ñ–≤
      localStorage.setItem('battle_history', JSON.stringify(history));
    } catch (e) {
      // –Ø–∫—â–æ –Ω–µ JSON ‚Äî —ñ–≥–Ω–æ—Ä—É—î–º–æ
    }
    originalSendData(data);
  }
</script>
</body>
</html>
