<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Conflict of Nations WebApp</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
  body {
    background: #1e1e2f;
    color: white;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    padding: 20px;
    max-width: 600px;
    margin: auto;
    line-height: 1.5;
  }

  h1, h2, h3 {
    text-align: center;
    margin-bottom: 15px;
    color: #ffffff;
  }

  .tabs {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 5px;
    margin-bottom: 20px;
  }

  .tabs button {
    flex: 1;
    min-width: 100px;
    padding: 10px;
    background-color: #444;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .tabs button:hover {
    background-color: #555;
  }

  .tabs button.active {
    background-color: #007bff;
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  button {
    background-color: #007bff;
    border: none;
    color: white;
    padding: 12px 25px;
    margin: 8px 0;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    width: 100%;
    transition: background-color 0.2s ease;
  }

  button:hover {
    background-color: #0056b3;
  }

  input, select, textarea {
    width: 100%;
    padding: 10px;
    margin-top: 8px;
    margin-bottom: 15px;
    border-radius: 6px;
    border: none;
    font-size: 16px;
    background-color: #2e2e45;
    color: white;
  }

  input::placeholder {
    color: #ccc;
  }

  .hidden {
    display: none;
  }

  .section {
    margin-top: 20px;
    padding: 15px;
    background: #2e2e45;
    border-radius: 10px;
    box-shadow: 0 0 8px rgba(0,0,0,0.2);
  }

  label {
    font-weight: bold;
    display: block;
    margin-top: 10px;
    margin-bottom: 5px;
  }

  .result {
    margin-top: 10px;
    padding: 10px;
    background: #444466;
    border-radius: 6px;
    min-height: 40px;
    white-space: pre-wrap;
  }

  #mafia_game_log {
    background: #111;
    color: #0f0;
    padding: 10px;
    height: 150px;
    overflow-y: auto;
    border-radius: 6px;
    margin-top: 10px;
    white-space: pre-wrap;
    font-family: monospace;
    font-size: 14px;
  }

  #mafia_choices {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 10px;
  }

  #mafia_choices button {
    padding: 8px 14px;
    font-size: 14px;
    background-color: #0069d9;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    flex: 0 1 auto;
  }

  #mafia_choices button:hover {
    background-color: #0056b3;
  }

  @media (max-width: 500px) {
    button {
      font-size: 14px;
      padding: 10px 20px;
    }

    .tabs button {
      min-width: 90px;
      font-size: 14px;
    }
  }

  .subtabs {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-bottom: 15px;
}

.subtab-button {
  background-color: #444;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 8px 20px;
  cursor: pointer;
  font-size: 16px;
  transition: background-color 0.3s ease;
}

.subtab-button.active,
.subtab-button:hover {
  background-color: #007bff;
}

.subtab-content {
  display: none;
}

.subtab-content.active {
  display: block;
}
  /* –í—ñ–¥—Å—Ç—É–ø–∏ —ñ —Ñ–æ–Ω –≤–∫–ª–∞–¥–∫–∏ */
  #admin-panel {
    background: #f9fafb;
    border-radius: 8px;
    padding: 20px;
    max-width: 900px;
    margin: 0 auto;
    box-shadow: 0 2px 10px rgb(0 0 0 / 0.1);
  }

  /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */
  #admin-panel h3 {
    color: #2c3e50;
    font-weight: 700;
    margin-bottom: 15px;
  }

  /* –¢–∞–±–ª–∏—Ü—ñ */
  table.table {
    background: white;
    border-radius: 6px;
    overflow: hidden;
  }

  table.table thead {
    background-color: #007bff;
    color: white;
  }

  table.table th,
  table.table td {
    padding: 12px 15px;
    vertical-align: middle;
    text-align: center;
  }

  /* –ö–Ω–æ–ø–∫–∏ */
  button.btn {
    min-width: 70px;
    margin: 0 3px;
    font-size: 0.85rem;
  }

  button.btn-sm {
    padding: 5px 10px;
  }

  /* –°—Ç–∞—Ç—É—Å–∏ */
  td.status-active {
    color: #28a745; /* –∑–µ–ª–µ–Ω–∏–π */
    font-weight: 600;
  }
  td.status-muted {
    color: #ffc107; /* –∂–æ–≤—Ç–∏–π */
    font-weight: 600;
  }
  td.status-banned {
    color: #dc3545; /* —á–µ—Ä–≤–æ–Ω–∏–π */
    font-weight: 600;
  }

  /* –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ */
  .modal-content {
    border-radius: 12px;
  }

  .modal-header {
    border-bottom: 2px solid #007bff;
  }

  /* Hover –µ—Ñ–µ–∫—Ç–∏ –Ω–∞ —Ä—è–¥–∫–∞—Ö */
  tbody tr:hover {
    background-color: #f1f7ff;
    cursor: pointer;
  }
  </style>
</head>
<body>
<h1>ü™ñ Conflict of Nations WebApp</h1>

<!-- –í–∫–ª–∞–¥–∫–∏ -->
<div class="tabs">
  <button onclick="switchTab('tools', event)" class="active">üîß –Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏</button>
  <button onclick="switchTab('games', event)">üéÆ –Ü–≥—Ä–∏</button>
  <button onclick="switchTab('admin', event)">‚öôÔ∏è –ê–¥–º—ñ–Ω</button>
  <button onclick="switchTab('blacklist', event)">üö´ –ë–ß–°</button>
  <button onclick="switchTab('history', event)">üìú –Ü—Å—Ç–æ—Ä—ñ—è</button>
</div>

<!-- –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–æ–∫ -->
<div id="tools" class="tab-content active">
  <div id="menu" class="section">
    <button onclick="showSection('analyze')">‚öîÔ∏è –ê–Ω–∞–ª—ñ–∑ –±–æ—é</button>
    <button onclick="showSection('calculator')">üìâ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤—Ç—Ä–∞—Ç</button>
    <button onclick="showSection('forecast')">üîÆ –ü—Ä–æ–≥–Ω–æ–∑ –±–æ—é</button>
    <button onclick="showSection('converter')">üí∞ –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä —Ä–µ—Å—É—Ä—Å—ñ–≤</button>
    <button onclick="showSection('tracker')">üìä –¢—Ä–µ–∫–µ—Ä –ø—Ä–æ–≥—Ä–µ—Å—É</button>
  </div>

  <div id="analyze" class="section hidden">
    <h2>‚öîÔ∏è –ê–Ω–∞–ª—ñ–∑ –±–æ—é</h2>
    <label>–ê—Ç–∞–∫—É—é—á—ñ —Å–∏–ª–∏:</label>
    <input type="number" id="analyze_attack" placeholder="–í–≤–µ–¥–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å" />
    <label>–û–±–æ—Ä–æ–Ω–Ω—ñ —Å–∏–ª–∏:</label>
    <input type="number" id="analyze_defense" placeholder="–í–≤–µ–¥–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å" />
    <button onclick="analyzeBattle()">–ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏</button>
    <div id="analyze_result" class="result"></div>
  </div>

  <div id="calculator" class="section hidden">
    <h2>üìâ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤—Ç—Ä–∞—Ç</h2>
    <label>–ê—Ç–∞–∫—É—é—á—ñ —Å–∏–ª–∏:</label>
    <input type="number" id="calc_attack" placeholder="–í–≤–µ–¥–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å" />
    <label>–û–±–æ—Ä–æ–Ω–Ω—ñ —Å–∏–ª–∏:</label>
    <input type="number" id="calc_defense" placeholder="–í–≤–µ–¥–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å" />
    <button onclick="calculateLosses()">–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –≤—Ç—Ä–∞—Ç–∏</button>
    <div id="calculator_result" class="result"></div>
  </div>

  <div id="forecast" class="section hidden">
    <h2>üîÆ –ü—Ä–æ–≥–Ω–æ–∑ –±–æ—é</h2>
    <label>–ê—Ç–∞–∫—É—é—á—ñ —Å–∏–ª–∏:</label>
    <input type="number" id="forecast_attack" placeholder="–í–≤–µ–¥–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å" />
    <label>–û–±–æ—Ä–æ–Ω–Ω—ñ —Å–∏–ª–∏:</label>
    <input type="number" id="forecast_defense" placeholder="–í–≤–µ–¥–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å" />
    <button onclick="forecastBattle()">–û—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑</button>
    <div id="forecast_result" class="result"></div>
  </div>

  <div id="converter" class="section hidden">
    <h2>üí∞ –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä —Ä–µ—Å—É—Ä—Å—ñ–≤</h2>
    <label>–ú–µ—Ç–∞–ª:</label>
    <input type="number" id="convert_metal" placeholder="–í–≤–µ–¥–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å" />
    <label>–ü–∞–ª–∏–≤–æ:</label>
    <input type="number" id="convert_fuel" placeholder="–í–≤–µ–¥–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å" />
    <button onclick="convertResources()">–ö–æ–Ω–≤–µ—Ä—Ç—É–≤–∞—Ç–∏</button>
    <div id="converter_result" class="result"></div>
  </div>

  <div id="tracker" class="section hidden">
    <h2>üìä –¢—Ä–µ–∫–µ—Ä –ø—Ä–æ–≥—Ä–µ—Å—É</h2>
    <button onclick="showHistory()">–ü–æ–∫–∞–∑–∞—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é</button>
    <div id="tracker_result" class="result"></div>
  </div>
</div>

<div id="games" class="tab-content">
  <div class="section">
    <h2>üéÆ –Ü–≥—Ä–∏</h2>
    <p>–¢—É—Ç –±—É–¥—É—Ç—å –º—ñ–Ω—ñ-—ñ–≥—Ä–∏: –≤—ñ–∫—Ç–æ—Ä–∏–Ω–∏, –º–µ–º–∏, random —Ç–æ—â–æ.</p>

    <div class="subtabs">
      <button class="subtab-button active" onclick="switchSubTab('mafia_game_section', event)">–ú–∞—Ñ—ñ—è</button>
      <button class="subtab-button" onclick="switchSubTab('battle_simulation_section', event)">–ú—ñ–Ω—ñ-—Å–∏–º—É–ª—è—Ü—ñ—è –±–æ—é</button>
    </div>

    <div id="mafia_game_section" class="subtab-content active">
      <h3>–ú–∞—Ñ—ñ—è</h3>
      <label for="mafia_players">–ö—ñ–ª—å–∫—ñ—Å—Ç—å –≥—Ä–∞–≤—Ü—ñ–≤ (4-10):</label>
      <input type="number" id="mafia_players" min="4" max="10" value="6" />
      <button onclick="startMafiaGame()">–ü–æ—á–∞—Ç–∏ –≥—Ä—É</button>
      <pre id="mafia_game_log"></pre>
      <div id="mafia_choices"></div>
    </div>

    <div id="battle_simulation_section" class="subtab-content" style="margin-top:30px;">
      <h3>üõ°Ô∏è –ú—ñ–Ω—ñ-—Å–∏–º—É–ª—è—Ü—ñ—è –±–æ—é</h3>
      <p>–û–±–µ—Ä–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —é–Ω—ñ—Ç—ñ–≤ (—Ç–∏–ø–∏: –ü—ñ—Ö–æ—Ç–∞, –¢–∞–Ω–∫–∏, –ê—Ä—Ç–∏–ª–µ—Ä—ñ—è, –í–ü–°)</p>

      <label>–ü—ñ—Ö–æ—Ç–∞:</label>
      <input type="number" id="infantry" min="0" max="100" value="10" />

      <label>–¢–∞–Ω–∫–∏:</label>
      <input type="number" id="tanks" min="0" max="50" value="5" />

      <label>–ê—Ä—Ç–∏–ª–µ—Ä—ñ—è:</label>
      <input type="number" id="artillery" min="0" max="30" value="3" />

      <label>–í–ü–°:</label>
      <input type="number" id="airforce" min="0" max="20" value="2" />

      <button onclick="simulateBattle()">–ü–æ—á–∞—Ç–∏ –±—ñ–π</button>

      <div id="battle_result" class="result"></div>
      <div id="score_display">–ë–∞–ª–∏: 0</div>
    </div>
  </div>
</div>

<div id="admin" class="tab-content">
  <div class="section">
    <h2>‚öôÔ∏è –ê–¥–º—ñ–Ω</h2>
    <div id="admin-panel" class="p-3">
  <h3>üì∫ –ê–¥–º—ñ–Ω–∫–∞ ‚Äì –ö–∞–Ω–∞–ª–∏</h3>
  <table class="table table-bordered mt-3" id="channelsTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>–ù–∞–∑–≤–∞</th>
        <th>–î—ñ—ó</th>
      </tr>
    </thead>
    <tbody>
      <!-- –î–∏–Ω–∞–º—ñ—á–Ω–æ –¥–æ–¥–∞—î—Ç—å—Å—è -->
    </tbody>
  </table>

  <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –∑ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏ –∫–∞–Ω–∞–ª—É -->
  <div class="modal fade" id="usersModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">üë• –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –∫–∞–Ω–∞–ª—É</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <table class="table" id="usersTable">
            <thead><tr><th>ID</th><th>–Ü–º'—è</th><th>–†–æ–ª—å</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î—ñ—ó</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
    </div>
  </div>
</div>

<div id="blacklist" class="tab-content">
  <div class="section">
    <h2>üö´ –ß–æ—Ä–Ω–∏–π —Å–ø–∏—Å–æ–∫</h2>
    <p>–°–ø–∏—Å–æ–∫ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤.</p>
  </div>
</div>

<div id="history" class="tab-content">
  <div class="section">
    <h2>üìú –Ü—Å—Ç–æ—Ä—ñ—è</h2>
    <p>–¢—É—Ç –±—É–¥–µ —ñ—Å—Ç–æ—Ä—ñ—è –¥—ñ–π, –ª–æ–≥, —Ö—Ä–æ–Ω–æ–ª–æ–≥—ñ—è.</p>
  </div>
</div>
</body>
<script>
  const tg = window.Telegram.WebApp;
  tg.expand();

  function switchTab(tabId, event) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    if(event) event.target.classList.add('active');
  }

  function showSection(sectionId) {
    const sections = ['analyze','calculator','forecast','converter','tracker'];
    sections.forEach(id => {
      document.getElementById(id).classList.add('hidden');
    });
    document.getElementById(sectionId).classList.remove('hidden');
  }

  function sendData(type, payload) {
    const data = JSON.stringify({type, ...payload});
    tg.sendData(data);
  }

  function analyzeBattle() {
    const atk = Number(document.getElementById('analyze_attack').value);
    const def = Number(document.getElementById('analyze_defense').value);
    if (!atk || !def) {
      alert("–í–≤–µ–¥–∏ –∫–æ—Ä–µ–∫—Ç–Ω—ñ —á–∏—Å–ª–∞");
      return;
    }
    const eff = (atk / (def + 1) * 100).toFixed(2);
    document.getElementById('analyze_result').innerText = `–ï—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –±–æ—é: ${eff}%`;
    sendData('analyze', {attack: atk, defense: def, efficiency: eff});
  }

  function calculateLosses() {
    const atk = Number(document.getElementById('calc_attack').value);
    const def = Number(document.getElementById('calc_defense').value);
    if (!atk || !def) {
      alert("–í–≤–µ–¥–∏ –∫–æ—Ä–µ–∫—Ç–Ω—ñ —á–∏—Å–ª–∞");
      return;
    }
    const atkLoss = Math.round(atk * 0.3);
    const defLoss = Math.round(def * 0.5);
    document.getElementById('calculator_result').innerText = `–í—Ç—Ä–∞—Ç–∏ –∞—Ç–∞–∫—É—é—á–∏—Ö: ${atkLoss}\n–í—Ç—Ä–∞—Ç–∏ –æ–±–æ—Ä–æ–Ω–Ω–∏—Ö: ${defLoss}`;
    sendData('calculator', {attack: atk, defense: def, atkLoss, defLoss});
  }

  function forecastBattle() {
    const atk = Number(document.getElementById('forecast_attack').value);
    const def = Number(document.getElementById('forecast_defense').value);
    if (!atk || !def) {
      alert("–í–≤–µ–¥–∏ –∫–æ—Ä–µ–∫—Ç–Ω—ñ —á–∏—Å–ª–∞");
      return;
    }
    let winner = '–ù—ñ—á–∏—è';
    if(atk > def * 1.2) winner = '–ü–µ—Ä–µ–º–æ–≥–∞ –∞—Ç–∞–∫—É—é—á–∏—Ö';
    else if(def > atk * 1.2) winner = '–ü–µ—Ä–µ–º–æ–≥–∞ –æ–±–æ—Ä–æ–Ω–Ω–∏—Ö';
    document.getElementById('forecast_result').innerText = `–ü—Ä–æ–≥–Ω–æ–∑: ${winner}`;
    sendData('forecast', {attack: atk, defense: def, winner});
  }

  function convertResources() {
    const metal = Number(document.getElementById('convert_metal').value);
    const fuel = Number(document.getElementById('convert_fuel').value);
    if (isNaN(metal) || isNaN(fuel)) {
      alert("–í–≤–µ–¥–∏ —á–∏—Å–ª–∞ –¥–ª—è –º–µ—Ç–∞–ª—É —ñ –ø–∞–ª–∏–≤–∞");
      return;
    }
    // –ü—Ä–∏–∫–ª–∞–¥ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó: 1 –º–µ—Ç–∞–ª = 2 –ø–∞–ª–∏–≤–∞ (—É–º–æ–≤–Ω–æ)
    const totalFuelEquivalent = metal * 2 + fuel;
    document.getElementById('converter_result').innerText = `–ó–∞–≥–∞–ª—å–Ω–∏–π –µ–∫–≤—ñ–≤–∞–ª–µ–Ω—Ç –ø–∞–ª–∏–≤–∞: ${totalFuelEquivalent}`;
    sendData('converter', {metal, fuel, totalFuelEquivalent});
  }

  function showHistory() {
    // –¢—É—Ç –º–æ–∂–Ω–∞ –±—É–ª–æ –± –ø—ñ–¥–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –∑ —Å–µ—Ä–≤–µ—Ä–∞ –∞–±–æ –ª–æ–∫–∞–ª—å–Ω–æ
    const dummyHistory = [
      "12:00 - –ë—ñ–π –º—ñ–∂ –∫—Ä–∞—ó–Ω–∞–º–∏ A —ñ B",
      "12:05 - –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤—Ç—Ä–∞—Ç –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ",
      "12:10 - –ü—Ä–æ–≥–Ω–æ–∑ –±–æ—é –æ—Ç—Ä–∏–º–∞–Ω–æ"
    ].join('\n');
    document.getElementById('tracker_result').innerText = dummyHistory;
    sendData('history', {action: 'show'});
  }

  // --- –ú–∞—Ñ—ñ—è (–ø—Ä–æ—Å—Ç–∞ –≥—Ä–∞) ---
  const mafiaRoles = ['–ú–∞—Ñ—ñ—è', '–î–æ–Ω', '–ö–æ–º—ñ—Å–∞—Ä', '–î–æ–∫—Ç–æ—Ä', '–ú–∏—Ä–Ω–∏–π', '–ú–∏—Ä–Ω–∏–π', '–ú–∏—Ä–Ω–∏–π', '–ú–∏—Ä–Ω–∏–π', '–ú–∏—Ä–Ω–∏–π', '–ú–∏—Ä–Ω–∏–π'];

  let mafiaGame = {
    players: 0,
    roles: [],
    alive: [],
    phase: 'none',
    logElement: null,
    choicesElement: null,
  };

  function startMafiaGame() {
    const numPlayers = Number(document.getElementById('mafia_players').value);
    if (numPlayers < 4 || numPlayers > 10) {
      alert("–ö—ñ–ª—å–∫—ñ—Å—Ç—å –≥—Ä–∞–≤—Ü—ñ–≤ –º–∞—î –±—É—Ç–∏ –≤—ñ–¥ 4 –¥–æ 10");
      return;
    }

    mafiaGame.players = numPlayers;
    mafiaGame.roles = mafiaRoles.slice(0, numPlayers);
    shuffleArray(mafiaGame.roles);
    mafiaGame.alive = Array(numPlayers).fill(true);
    mafiaGame.phase = 'night';
    mafiaGame.logElement = document.getElementById('mafia_game_log');
    mafiaGame.choicesElement = document.getElementById('mafia_choices');
    mafiaGame.logElement.textContent = `–ì—Ä–∞ –ø–æ—á–∞–ª–∞—Å—å! –ö—ñ–ª—å–∫—ñ—Å—Ç—å –≥—Ä–∞–≤—Ü—ñ–≤: ${numPlayers}\n–†–æ–ª—ñ —Ä–æ–∑–ø–æ–¥—ñ–ª–µ–Ω—ñ.\n–ù—ñ—á–Ω–∞ —Ñ–∞–∑–∞.\n`;
    mafiaGame.choicesElement.innerHTML = '';
    mafiaGame.currentNightAction();
  }

  function shuffleArray(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
  }

  mafiaGame.currentNightAction = function() {
    // –ù–∞ –Ω—ñ—á –ú–∞—Ñ—ñ—è –≤–∏–±–∏—Ä–∞—î –∂–µ—Ä—Ç–≤—É
    const mafiaIndexes = [];
    for (let i=0; i<this.players; i++) {
      if (this.alive[i] && (this.roles[i] === '–ú–∞—Ñ—ñ—è' || this.roles[i] === '–î–æ–Ω')) {
        mafiaIndexes.push(i);
      }
    }
    if (mafiaIndexes.length === 0) {
      this.logElement.textContent += "–í—Å—ñ –º–∞—Ñ—ñ–æ–∑—ñ –º–µ—Ä—Ç–≤—ñ, –Ω—ñ—á –ø—Ä–æ–ø—É—Å–∫–∞—î—Ç—å—Å—è.\n";
      this.phase = 'day';
      this.dayPhase();
      return;
    }

    this.logElement.textContent += "–ú–∞—Ñ—ñ—è, –≤–∏–±–µ—Ä—ñ—Ç—å –∂–µ—Ä—Ç–≤—É –¥–ª—è –≤–±–∏–≤—Å—Ç–≤–∞:\n";
    this.choicesElement.innerHTML = '';
    for (let i=0; i<this.players; i++) {
      if (this.alive[i] && !mafiaIndexes.includes(i)) {
        const btn = document.createElement('button');
        btn.textContent = `–í–±–∏—Ç–∏ –≥—Ä–∞–≤—Ü—è #${i+1} (${this.roles[i]})`;
        btn.onclick = () => {
          this.killTarget = i;
          this.logElement.textContent += `–ú–∞—Ñ—ñ—è –≤–∏–±—Ä–∞–ª–∞ –≥—Ä–∞–≤—Ü—è #${i+1}.\n`;
          this.choicesElement.innerHTML = '';
          this.doDoctorAction();
        };
        this.choicesElement.appendChild(btn);
      }
    }
  };

  mafiaGame.doDoctorAction = function() {
    // –î–æ–∫—Ç–æ—Ä –≤–∏–±–∏—Ä–∞—î –∫–æ–≥–æ –ª—ñ–∫—É–≤–∞—Ç–∏
    this.logElement.textContent += "–î–æ–∫—Ç–æ—Ä, –≤–∏–±–µ—Ä—ñ—Ç—å –∫–æ–≥–æ –ª—ñ–∫—É–≤–∞—Ç–∏:\n";
    this.choicesElement.innerHTML = '';
    for (let i=0; i<this.players; i++) {
      if (this.alive[i]) {
        const btn = document.createElement('button');
        btn.textContent = `–í–∏–ª—ñ–∫—É–≤–∞—Ç–∏ –≥—Ä–∞–≤—Ü—è #${i+1}`;
        btn.onclick = () => {
          this.protectTarget = i;
          this.logElement.textContent += `–î–æ–∫—Ç–æ—Ä –≤–∏–±—Ä–∞–≤ –≥—Ä–∞–≤—Ü—è #${i+1} –¥–ª—è –ª—ñ–∫—É–≤–∞–Ω–Ω—è.\n`;
          this.choicesElement.innerHTML = '';
          this.resolveNight();
        };
        this.choicesElement.appendChild(btn);
      }
    }
  };

  mafiaGame.resolveNight = function() {
    if (this.killTarget === this.protectTarget) {
      this.logElement.textContent += "–ñ–µ—Ä—Ç–≤–∞ –≤—Ä—è—Ç–æ–≤–∞–Ω–∞ –¥–æ–∫—Ç–æ—Ä–æ–º!\n";
    } else {
      this.alive[this.killTarget] = false;
      this.logElement.textContent += `–ì—Ä–∞–≤–µ—Ü—å #${this.killTarget+1} (${this.roles[this.killTarget]}) –≤–±–∏—Ç–∏–π –≤–Ω–æ—á—ñ.\n`;
    }
    this.phase = 'day';
    this.dayPhase();
  };

  mafiaGame.dayPhase = function() {
    this.logElement.textContent += "–î–µ–Ω–Ω–∞ —Ñ–∞–∑–∞. –û–±–≥–æ–≤–æ—Ä–µ–Ω–Ω—è —ñ –≥–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è.\n";
    this.choicesElement.innerHTML = '';
    // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç–∏, –º–æ–∂–Ω–∞ –≤–∏–±—Ä–∞—Ç–∏ —Ö—Ç–æ –±—É–¥–µ –ø–æ–≤—ñ—à–µ–Ω–∏–π
    this.logElement.textContent += "–í–∏–±–µ—Ä—ñ—Ç—å –≥—Ä–∞–≤—Ü—è –¥–ª—è –≥–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è –Ω–∞ –≤–∏–ª—É—á–µ–Ω–Ω—è:\n";
    for (let i=0; i<this.players; i++) {
      if (this.alive[i]) {
        const btn = document.createElement('button');
        btn.textContent = `–ü–æ–≤—ñ—Å–∏—Ç–∏ –≥—Ä–∞–≤—Ü—è #${i+1} (${this.roles[i]})`;
        btn.onclick = () => {
          this.alive[i] = false;
          this.logElement.textContent += `–ì—Ä–∞–≤–µ—Ü—å #${i+1} (${this.roles[i]}) –±—É–≤ –ø–æ–≤—ñ—à–µ–Ω–∏–π.\n`;
          this.choicesElement.innerHTML = '';
          this.checkWinConditions();
        };
        this.choicesElement.appendChild(btn);
      }
    }
  };

  mafiaGame.checkWinConditions = function() {
    const mafiaAlive = this.roles.reduce((count, role, i) => (this.alive[i] && (role === '–ú–∞—Ñ—ñ—è' || role === '–î–æ–Ω')) ? count + 1 : count, 0);
    const othersAlive = this.alive.reduce((count, alive, i) => (alive && (this.roles[i] !== '–ú–∞—Ñ—ñ—è' && this.roles[i] !== '–î–æ–Ω')) ? count + 1 : count, 0);

    if (mafiaAlive === 0) {
      this.logElement.textContent += "–í–∏–≥—Ä–∞–ª–∏ –ú–∏—Ä–Ω—ñ!\n–ì—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.";
      this.choicesElement.innerHTML = '';
      this.phase = 'finished';
      return;
    }
    if (mafiaAlive >= othersAlive) {
      this.logElement.textContent += "–í–∏–≥—Ä–∞–ª–∞ –ú–∞—Ñ—ñ—è!\n–ì—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.";
      this.choicesElement.innerHTML = '';
      this.phase = 'finished';
      return;
    }

    // –Ü–Ω–∞–∫—à–µ - –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –Ω–∞—Å—Ç—É–ø–Ω–∞ –Ω—ñ—á
    this.phase = 'night';
    this.killTarget = null;
    this.protectTarget = null;
    this.logElement.textContent += "\n–ù–∞—Å—Ç—É–ø–Ω–∞ –Ω—ñ—á.\n";
    this.currentNightAction();
  };

  // –ë–∞–ª–∏
function getScore() {
  return Number(localStorage.getItem('battleScore')) || 0;
}

function setScore(score) {
  localStorage.setItem('battleScore', score);
  document.getElementById('score_display').innerText = `–ë–∞–ª–∏: ${score}`;
}

// –§—É–Ω–∫—Ü—ñ—è —Å–∏–º—É–ª—è—Ü—ñ—ó –±–æ—é
function simulateBattle() {
  // –í–∏—Ç—è–≥—É—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —é–Ω—ñ—Ç—ñ–≤ –≥—Ä–∞–≤—Ü—è
  const playerUnits = {
    infantry: Number(document.getElementById('infantry').value),
    tanks: Number(document.getElementById('tanks').value),
    artillery: Number(document.getElementById('artillery').value),
    airforce: Number(document.getElementById('airforce').value)
  };

  // –°—Ç–≤–æ—Ä—é—î–º–æ –≤–∏–ø–∞–¥–∫–æ–≤–æ–≥–æ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ –∑ –ø—Ä–∏–±–ª–∏–∑–Ω–æ —Ç–∞–∫–∏–º–∏ –∂ –∑–Ω–∞—á–µ–Ω–Ω—è–º–∏
  function randomUnit(base) {
    return Math.max(0, Math.round(base * (0.7 + Math.random() * 0.6))); // –≤—ñ–¥ 70% –¥–æ 130%
  }
  const enemyUnits = {
    infantry: randomUnit(playerUnits.infantry),
    tanks: randomUnit(playerUnits.tanks),
    artillery: randomUnit(playerUnits.artillery),
    airforce: randomUnit(playerUnits.airforce)
  };

  // –°–∏–ª–∞ —é–Ω—ñ—Ç—ñ–≤ (–≤–∞–≥–∏ —É–º–æ–≤–Ω—ñ)
  const weights = {
    infantry: 1,
    tanks: 5,
    artillery: 3,
    airforce: 4
  };

  function armyPower(units) {
    return units.infantry * weights.infantry +
           units.tanks * weights.tanks +
           units.artillery * weights.artillery +
           units.airforce * weights.airforce;
  }

  const playerPower = armyPower(playerUnits);
  const enemyPower = armyPower(enemyUnits);

  let resultText = `–¢–≤–æ—è –∞—Ä–º—ñ—è: ${playerPower.toFixed(1)} —Å–∏–ª\n` +
                   `–í–æ—Ä–æ–∂–∞ –∞—Ä–º—ñ—è: ${enemyPower.toFixed(1)} —Å–∏–ª\n`;

  // –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –ø–µ—Ä–µ–º–æ–∂—Ü—è
  if(playerPower > enemyPower * 1.2) {
    resultText += "–ü–µ—Ä–µ–º–æ–≥–∞! üéâ +1 –±–∞–ª";
    let score = getScore() + 1;
    setScore(score);
  } else if(enemyPower > playerPower * 1.2) {
    resultText += "–ü—Ä–æ–≥—Ä–∞—à. –°–ø—Ä–æ–±—É–π —â–µ.";
  } else {
    resultText += "–ù—ñ—á–∏—è.";
  }

  // –í–∏–≤—ñ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
  document.getElementById('battle_result').innerText = resultText;
}

// –í—ñ–¥–æ–±—Ä–∞–∑–∏—Ç–∏ –ø–æ—á–∞—Ç–∫–æ–≤–∏–π –±–∞–ª –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
window.onload = function() {
  if(document.getElementById('score_display')) {
    setScore(getScore());
  }
};
function switchSubTab(sectionId, event) {
  document.querySelectorAll('.subtab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.subtab-button').forEach(btn => btn.classList.remove('active'));

  document.getElementById(sectionId).classList.add('active');
  if(event) event.target.classList.add('active');
}
  async function loadChannels() {
    const response = await fetch('/api/channels'); // –∞–±–æ /bot/channels
    const channels = await response.json();
    const tbody = document.querySelector("#channelsTable tbody");
    tbody.innerHTML = "";

    channels.forEach(channel => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${channel.id}</td>
        <td>${channel.name}</td>
        <td>
          <button class="btn btn-primary btn-sm" onclick="showUsers('${channel.id}')">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // –í–∏–∫–ª–∏–∫–∞—î–º–æ –æ–¥—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
  loadChannels();
  async function showUsers(channelId) {
    const response = await fetch(`/api/users?channelId=${channelId}`);
    const users = await response.json();
    const tbody = document.querySelector("#usersTable tbody");
    tbody.innerHTML = "";

    users.forEach(user => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${user.id}</td>
        <td>${user.name}</td>
        <td>${user.role}</td>
        <td>
          ${user.isBanned ? "üö´ –ë–∞–Ω" : user.isMuted ? "üîá –ú—É—Ç" : "‚úÖ –ê–∫—Ç–∏–≤–Ω–∏–π"}
        </td>
        <td>
          <button class="btn btn-warning btn-sm" onclick="muteUser('${user.id}')">–ú—É—Ç</button>
          <button class="btn btn-danger btn-sm" onclick="banUser('${user.id}')">–ë–∞–Ω</button>
          <button class="btn btn-secondary btn-sm" onclick="changeRole('${user.id}')">–†–æ–ª—å</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    const modal = new bootstrap.Modal(document.getElementById("usersModal"));
    modal.show();
  }
  async function muteUser(userId) {
    await fetch(`/api/users/${userId}/mute`, { method: 'POST' });
    alert("üîá –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–∞–º—É—á–µ–Ω–∏–π");
    document.querySelector("#usersModal .btn-close").click();
  }

  async function banUser(userId) {
    await fetch(`/api/users/${userId}/ban`, { method: 'POST' });
    alert("üö´ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–∞–±–∞–Ω–µ–Ω–∏–π");
    document.querySelector("#usersModal .btn-close").click();
  }

  async function changeRole(userId) {
    const newRole = prompt("–ù–æ–≤–∞ —Ä–æ–ª—å: user / moderator / admin");
    if (!newRole) return;
    await fetch(`/api/users/${userId}/role`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ role: newRole })
    });
    alert("üéñ –†–æ–ª—å –æ–Ω–æ–≤–ª–µ–Ω–æ");
    document.querySelector("#usersModal .btn-close").click();
  }
</script>
</body>
</html>
